name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Ballerina
      uses: ballerina-platform/setup-ballerina@v1.1.0
      with:
        version: latest
    
    - name: Build
      run: bal build
    
    - name: Start Service in Background
      run: |
        bal run src/service/service.bal &
        echo $! > service.pid
        sleep 5
    
    - name: Wait for Service to be Ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8080/hello; do sleep 1; done'
    
    - name: Run Tests
      run: bal test
    
    - name: Stop Service
      if: always()
      run: |
        if [ -f service.pid ]; then
          kill $(cat service.pid) || true
        fi

  docker-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker Image
      run: docker build -t wso2-ballerina-service .
    
    - name: Test Docker Image
      run: |
        docker run -d -p 8080:8080 --name test-container wso2-ballerina-service
        echo "Waiting for container to start..."
        sleep 15
        
        # Wait up to 60 seconds for service to be ready
        for i in {1..12}; do
          if curl -f http://localhost:8080/hello; then
            echo "Service is ready!"
            break
          fi
          echo "Attempt $i: Service not ready yet, waiting..."
          sleep 5
        done
        
        # Final test
        curl -f http://localhost:8080/hello || exit 1
        
        docker stop test-container
        docker rm test-container
